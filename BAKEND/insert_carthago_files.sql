-- =============================================================================
-- INSERTION DES FICHIERS CARTHAGO
-- =============================================================================
-- Script pour insérer les fichiers Carthago fournis dans la base de données

-- =============================================================================
-- 1. Insertion du premier fichier: Donnees1612202407221404504.DATA
-- =============================================================================
INSERT INTO CARTHAGO (NOM_FICHIER, DATE_IMPORT, CONTENU) 
VALUES (
    'Donnees1612202407221404504.DATA', 
    SYSDATE, 
    '10006174045040114047003423510000000001000000010307680A                                              
200061740000448045050370076771013730000000103076803016122024TT                                                                                                          
'
);

-- Récupérer l'ID du premier fichier
SELECT ID, NOM_FICHIER, DATE_IMPORT FROM CARTHAGO WHERE NOM_FICHIER = 'Donnees1612202407221404504.DATA';

-- =============================================================================
-- 2. Insertion du deuxième fichier: Donnees1612202408033904135.DATA
-- =============================================================================
INSERT INTO CARTHAGO (NOM_FICHIER, DATE_IMPORT, CONTENU) 
VALUES (
    'Donnees1612202408033904135.DATA', 
    SYSDATE, 
    '10475967041352170064144066730000000006000000008208232A                                              
204759672937872032201300115004647410000000031050003016122024TT                                                                                                          
204759676483759071210181101101498640000000028058583016122024TT                                                                                                          
204759676747680032101190115004484750000000004244503016122024TT                                                                                                          
204759670000304083000000010521408110000000002152003016122024TT                                                                                                          
204759671728809210030034047002300200000000005365003016122024TT                                                                                                          
204759671799548032101190115004017210000000011212243016122024TT                                                                                                          
'
);

-- Récupérer l'ID du deuxième fichier
SELECT ID, NOM_FICHIER, DATE_IMPORT FROM CARTHAGO WHERE NOM_FICHIER = 'Donnees1612202408033904135.DATA';

-- =============================================================================
-- 3. Parsing et insertion des détails pour le premier fichier
-- =============================================================================
-- Analyser la structure du fichier et extraire les informations
-- Format: [Type][Numero][Montant][Date][Statut]

-- Ligne 1: 10006174045040114047003423510000000001000000010307680A
-- Ligne 2: 200061740000448045050370076771013730000000103076803016122024TT

INSERT INTO CARTHAGO_DETAIL (CARTHAGO_ID, NUMERO_CHEQUE, MONTANT_CHEQUE, ETAT_CHEQUE, LIGNE_ORIGINE)
SELECT 
    c.ID,
    SUBSTR('10006174045040114047003423510000000001000000010307680A', 1, 20) as NUMERO_CHEQUE,
    TO_NUMBER(SUBSTR('10006174045040114047003423510000000001000000010307680A', 21, 15)) / 100 as MONTANT_CHEQUE,
    CASE 
        WHEN SUBSTR('10006174045040114047003423510000000001000000010307680A', 36, 1) = 'A' THEN 'DEPOSE'
        ELSE 'REJETE'
    END as ETAT_CHEQUE,
    '10006174045040114047003423510000000001000000010307680A' as LIGNE_ORIGINE
FROM CARTHAGO c 
WHERE c.NOM_FICHIER = 'Donnees1612202407221404504.DATA';

INSERT INTO CARTHAGO_DETAIL (CARTHAGO_ID, NUMERO_CHEQUE, MONTANT_CHEQUE, ETAT_CHEQUE, LIGNE_ORIGINE)
SELECT 
    c.ID,
    SUBSTR('200061740000448045050370076771013730000000103076803016122024TT', 1, 20) as NUMERO_CHEQUE,
    TO_NUMBER(SUBSTR('200061740000448045050370076771013730000000103076803016122024TT', 21, 15)) / 100 as MONTANT_CHEQUE,
    CASE 
        WHEN SUBSTR('200061740000448045050370076771013730000000103076803016122024TT', 36, 1) = 'A' THEN 'DEPOSE'
        ELSE 'REJETE'
    END as ETAT_CHEQUE,
    '200061740000448045050370076771013730000000103076803016122024TT' as LIGNE_ORIGINE
FROM CARTHAGO c 
WHERE c.NOM_FICHIER = 'Donnees1612202407221404504.DATA';

-- =============================================================================
-- 4. Parsing et insertion des détails pour le deuxième fichier
-- =============================================================================
-- Ce fichier contient 7 lignes de données

-- Ligne 1: 10475967041352170064144066730000000006000000008208232A
INSERT INTO CARTHAGO_DETAIL (CARTHAGO_ID, NUMERO_CHEQUE, MONTANT_CHEQUE, ETAT_CHEQUE, LIGNE_ORIGINE)
SELECT 
    c.ID,
    SUBSTR('10475967041352170064144066730000000006000000008208232A', 1, 20) as NUMERO_CHEQUE,
    TO_NUMBER(SUBSTR('10475967041352170064144066730000000006000000008208232A', 21, 15)) / 100 as MONTANT_CHEQUE,
    CASE 
        WHEN SUBSTR('10475967041352170064144066730000000006000000008208232A', 36, 1) = 'A' THEN 'DEPOSE'
        ELSE 'REJETE'
    END as ETAT_CHEQUE,
    '10475967041352170064144066730000000006000000008208232A' as LIGNE_ORIGINE
FROM CARTHAGO c 
WHERE c.NOM_FICHIER = 'Donnees1612202408033904135.DATA';

-- Ligne 2: 204759672937872032201300115004647410000000031050003016122024TT
INSERT INTO CARTHAGO_DETAIL (CARTHAGO_ID, NUMERO_CHEQUE, MONTANT_CHEQUE, ETAT_CHEQUE, LIGNE_ORIGINE)
SELECT 
    c.ID,
    SUBSTR('204759672937872032201300115004647410000000031050003016122024TT', 1, 20) as NUMERO_CHEQUE,
    TO_NUMBER(SUBSTR('204759672937872032201300115004647410000000031050003016122024TT', 21, 15)) / 100 as MONTANT_CHEQUE,
    CASE 
        WHEN SUBSTR('204759672937872032201300115004647410000000031050003016122024TT', 36, 1) = 'A' THEN 'DEPOSE'
        ELSE 'REJETE'
    END as ETAT_CHEQUE,
    '204759672937872032201300115004647410000000031050003016122024TT' as LIGNE_ORIGINE
FROM CARTHAGO c 
WHERE c.NOM_FICHIER = 'Donnees1612202408033904135.DATA';

-- Ligne 3: 204759676483759071210181101101498640000000028058583016122024TT
INSERT INTO CARTHAGO_DETAIL (CARTHAGO_ID, NUMERO_CHEQUE, MONTANT_CHEQUE, ETAT_CHEQUE, LIGNE_ORIGINE)
SELECT 
    c.ID,
    SUBSTR('204759676483759071210181101101498640000000028058583016122024TT', 1, 20) as NUMERO_CHEQUE,
    TO_NUMBER(SUBSTR('204759676483759071210181101101498640000000028058583016122024TT', 21, 15)) / 100 as MONTANT_CHEQUE,
    CASE 
        WHEN SUBSTR('204759676483759071210181101101498640000000028058583016122024TT', 36, 1) = 'A' THEN 'DEPOSE'
        ELSE 'REJETE'
    END as ETAT_CHEQUE,
    '204759676483759071210181101101498640000000028058583016122024TT' as LIGNE_ORIGINE
FROM CARTHAGO c 
WHERE c.NOM_FICHIER = 'Donnees1612202408033904135.DATA';

-- Ligne 4: 204759676747680032101190115004484750000000004244503016122024TT
INSERT INTO CARTHAGO_DETAIL (CARTHAGO_ID, NUMERO_CHEQUE, MONTANT_CHEQUE, ETAT_CHEQUE, LIGNE_ORIGINE)
SELECT 
    c.ID,
    SUBSTR('204759676747680032101190115004484750000000004244503016122024TT', 1, 20) as NUMERO_CHEQUE,
    TO_NUMBER(SUBSTR('204759676747680032101190115004484750000000004244503016122024TT', 21, 15)) / 100 as MONTANT_CHEQUE,
    CASE 
        WHEN SUBSTR('204759676747680032101190115004484750000000004244503016122024TT', 36, 1) = 'A' THEN 'DEPOSE'
        ELSE 'REJETE'
    END as ETAT_CHEQUE,
    '204759676747680032101190115004484750000000004244503016122024TT' as LIGNE_ORIGINE
FROM CARTHAGO c 
WHERE c.NOM_FICHIER = 'Donnees1612202408033904135.DATA';

-- Ligne 5: 204759670000304083000000010521408110000000002152003016122024TT
INSERT INTO CARTHAGO_DETAIL (CARTHAGO_ID, NUMERO_CHEQUE, MONTANT_CHEQUE, ETAT_CHEQUE, LIGNE_ORIGINE)
SELECT 
    c.ID,
    SUBSTR('204759670000304083000000010521408110000000002152003016122024TT', 1, 20) as NUMERO_CHEQUE,
    TO_NUMBER(SUBSTR('204759670000304083000000010521408110000000002152003016122024TT', 21, 15)) / 100 as MONTANT_CHEQUE,
    CASE 
        WHEN SUBSTR('204759670000304083000000010521408110000000002152003016122024TT', 36, 1) = 'A' THEN 'DEPOSE'
        ELSE 'REJETE'
    END as ETAT_CHEQUE,
    '204759670000304083000000010521408110000000002152003016122024TT' as LIGNE_ORIGINE
FROM CARTHAGO c 
WHERE c.NOM_FICHIER = 'Donnees1612202408033904135.DATA';

-- Ligne 6: 204759671728809210030034047002300200000000005365003016122024TT
INSERT INTO CARTHAGO_DETAIL (CARTHAGO_ID, NUMERO_CHEQUE, MONTANT_CHEQUE, ETAT_CHEQUE, LIGNE_ORIGINE)
SELECT 
    c.ID,
    SUBSTR('204759671728809210030034047002300200000000005365003016122024TT', 1, 20) as NUMERO_CHEQUE,
    TO_NUMBER(SUBSTR('204759671728809210030034047002300200000000005365003016122024TT', 21, 15)) / 100 as MONTANT_CHEQUE,
    CASE 
        WHEN SUBSTR('204759671728809210030034047002300200000000005365003016122024TT', 36, 1) = 'A' THEN 'DEPOSE'
        ELSE 'REJETE'
    END as ETAT_CHEQUE,
    '204759671728809210030034047002300200000000005365003016122024TT' as LIGNE_ORIGINE
FROM CARTHAGO c 
WHERE c.NOM_FICHIER = 'Donnees1612202408033904135.DATA';

-- Ligne 7: 204759671799548032101190115004017210000000011212243016122024TT
INSERT INTO CARTHAGO_DETAIL (CARTHAGO_ID, NUMERO_CHEQUE, MONTANT_CHEQUE, ETAT_CHEQUE, LIGNE_ORIGINE)
SELECT 
    c.ID,
    SUBSTR('204759671799548032101190115004017210000000011212243016122024TT', 1, 20) as NUMERO_CHEQUE,
    TO_NUMBER(SUBSTR('204759671799548032101190115004017210000000011212243016122024TT', 21, 15)) / 100 as MONTANT_CHEQUE,
    CASE 
        WHEN SUBSTR('204759671799548032101190115004017210000000011212243016122024TT', 36, 1) = 'A' THEN 'DEPOSE'
        ELSE 'REJETE'
    END as ETAT_CHEQUE,
    '204759671799548032101190115004017210000000011212243016122024TT' as LIGNE_ORIGINE
FROM CARTHAGO c 
WHERE c.NOM_FICHIER = 'Donnees1612202408033904135.DATA';

-- =============================================================================
-- 5. Vérification des insertions
-- =============================================================================

-- Vérifier les fichiers Carthago insérés
SELECT ID, NOM_FICHIER, DATE_IMPORT FROM CARTHAGO WHERE NOM_FICHIER LIKE 'Donnees%';

-- Vérifier les détails parsés
SELECT 
    c.NOM_FICHIER,
    cd.NUMERO_CHEQUE,
    cd.MONTANT_CHEQUE,
    cd.ETAT_CHEQUE,
    cd.LIGNE_ORIGINE
FROM CARTHAGO c
JOIN CARTHAGO_DETAIL cd ON c.ID = cd.CARTHAGO_ID
WHERE c.NOM_FICHIER LIKE 'Donnees%'
ORDER BY c.NOM_FICHIER, cd.NUMERO_CHEQUE;

-- Statistiques par fichier
SELECT 
    c.NOM_FICHIER,
    COUNT(cd.ID) as NOMBRE_TOTAL_CHEQUES,
    SUM(cd.MONTANT_CHEQUE) as MONTANT_TOTAL,
    COUNT(CASE WHEN cd.ETAT_CHEQUE = 'DEPOSE' THEN 1 END) as NOMBRE_DEPOSES,
    SUM(CASE WHEN cd.ETAT_CHEQUE = 'DEPOSE' THEN cd.MONTANT_CHEQUE ELSE 0 END) as MONTANT_DEPOSES,
    COUNT(CASE WHEN cd.ETAT_CHEQUE = 'REJETE' THEN 1 END) as NOMBRE_REJETES,
    SUM(CASE WHEN cd.ETAT_CHEQUE = 'REJETE' THEN cd.MONTANT_CHEQUE ELSE 0 END) as MONTANT_REJETES
FROM CARTHAGO c
LEFT JOIN CARTHAGO_DETAIL cd ON c.ID = cd.CARTHAGO_ID
WHERE c.NOM_FICHIER LIKE 'Donnees%'
GROUP BY c.ID, c.NOM_FICHIER, c.DATE_IMPORT;

-- =============================================================================
-- SCRIPT TERMINÉ
-- ============================================================================= 