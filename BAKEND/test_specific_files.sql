-- =============================================================================
-- TEST DES FICHIERS CARTHAGO SPÉCIFIQUES
-- =============================================================================
-- Script pour analyser et insérer les fichiers Carthago fournis par l'utilisateur

-- =============================================================================
-- 1. Analyse du premier fichier: Donnees1612202407221404504.DATA
-- =============================================================================

-- Contenu du fichier:
-- 10006174045040114047003423510000000001000000010307680A
-- 200061740000448045050370076771013730000000103076803016122024TT

-- Analyser la structure:
-- Ligne 1 (Entête): 10006174045040114047003423510000000001000000010307680A
-- - Nombre total: position 29-38 = "0000000010" = 10
-- - Montant total: position 39-53 = "00000000010307680" = 103076.80

-- Ligne 2 (Détail): 200061740000448045050370076771013730000000103076803016122024TT
-- - Montant chèque: position 36-50 = "00000000010307680" = 103076.80
-- - État: position 80 = "T" (probablement REJETE)

-- =============================================================================
-- 2. Analyse du deuxième fichier: Donnees1612202408033904135.DATA
-- =============================================================================

-- Contenu du fichier:
-- 10475967041352170064144066730000000006000000008208232A
-- 204759672937872032201300115004647410000000031050003016122024TT
-- 204759676483759071210181101101498640000000028058583016122024TT
-- 204759676747680032101190115004484750000000004244503016122024TT
-- 204759670000304083000000010521408110000000002152003016122024TT
-- 204759671728809210030034047002300200000000005365003016122024TT
-- 204759671799548032101190115004017210000000011212243016122024TT

-- Analyser la structure:
-- Ligne 1 (Entête): 10475967041352170064144066730000000006000000008208232A
-- - Nombre total: position 29-38 = "0000000006" = 6
-- - Montant total: position 39-53 = "0000000008208232" = 82082.32

-- Détails (6 lignes):
-- Ligne 2: 204759672937872032201300115004647410000000031050003016122024TT
-- - Montant: position 36-50 = "0000000003105000" = 31050.00
-- - État: position 80 = "T" (probablement REJETE)

-- Ligne 3: 204759676483759071210181101101498640000000028058583016122024TT
-- - Montant: position 36-50 = "0000000002805858" = 28058.58
-- - État: position 80 = "T" (probablement REJETE)

-- Ligne 4: 204759676747680032101190115004484750000000004244503016122024TT
-- - Montant: position 36-50 = "0000000000424450" = 4244.50
-- - État: position 80 = "T" (probablement REJETE)

-- Ligne 5: 204759670000304083000000010521408110000000002152003016122024TT
-- - Montant: position 36-50 = "0000000000215200" = 2152.00
-- - État: position 80 = "T" (probablement REJETE)

-- Ligne 6: 204759671728809210030034047002300200000000005365003016122024TT
-- - Montant: position 36-50 = "0000000000053650" = 5365.00
-- - État: position 80 = "T" (probablement REJETE)

-- Ligne 7: 204759671799548032101190115004017210000000011212243016122024TT
-- - Montant: position 36-50 = "0000000001121224" = 11212.24
-- - État: position 80 = "T" (probablement REJETE)

-- =============================================================================
-- 3. Insertion avec parsing correct
-- =============================================================================

-- Insérer le premier fichier
INSERT INTO CARTHAGO (NOM_FICHIER, DATE_IMPORT, CONTENU) 
VALUES (
    'Donnees1612202407221404504.DATA', 
    SYSDATE, 
    '10006174045040114047003423510000000001000000010307680A
200061740000448045050370076771013730000000103076803016122024TT'
);

-- Insérer le deuxième fichier
INSERT INTO CARTHAGO (NOM_FICHIER, DATE_IMPORT, CONTENU) 
VALUES (
    'Donnees1612202408033904135.DATA', 
    SYSDATE, 
    '10475967041352170064144066730000000006000000008208232A
204759672937872032201300115004647410000000031050003016122024TT
204759676483759071210181101101498640000000028058583016122024TT
204759676747680032101190115004484750000000004244503016122024TT
204759670000304083000000010521408110000000002152003016122024TT
204759671728809210030034047002300200000000005365003016122024TT
204759671799548032101190115004017210000000011212243016122024TT'
);

-- =============================================================================
-- 4. Parsing et insertion des détails avec la structure correcte
-- =============================================================================

-- Premier fichier - Détail 1
INSERT INTO CARTHAGO_DETAIL (CARTHAGO_ID, NUMERO_CHEQUE, MONTANT_CHEQUE, ETAT_CHEQUE, LIGNE_ORIGINE)
SELECT 
    c.ID,
    SUBSTR('200061740000448045050370076771013730000000103076803016122024TT', 1, 20) as NUMERO_CHEQUE,
    TO_NUMBER(SUBSTR('200061740000448045050370076771013730000000103076803016122024TT', 36, 15)) / 100 as MONTANT_CHEQUE,
    CASE 
        WHEN SUBSTR('200061740000448045050370076771013730000000103076803016122024TT', 80, 1) = 'A' THEN 'DEPOSE'
        ELSE 'REJETE'
    END as ETAT_CHEQUE,
    '200061740000448045050370076771013730000000103076803016122024TT' as LIGNE_ORIGINE
FROM CARTHAGO c 
WHERE c.NOM_FICHIER = 'Donnees1612202407221404504.DATA';

-- Deuxième fichier - Détail 1
INSERT INTO CARTHAGO_DETAIL (CARTHAGO_ID, NUMERO_CHEQUE, MONTANT_CHEQUE, ETAT_CHEQUE, LIGNE_ORIGINE)
SELECT 
    c.ID,
    SUBSTR('204759672937872032201300115004647410000000031050003016122024TT', 1, 20) as NUMERO_CHEQUE,
    TO_NUMBER(SUBSTR('204759672937872032201300115004647410000000031050003016122024TT', 36, 15)) / 100 as MONTANT_CHEQUE,
    CASE 
        WHEN SUBSTR('204759672937872032201300115004647410000000031050003016122024TT', 80, 1) = 'A' THEN 'DEPOSE'
        ELSE 'REJETE'
    END as ETAT_CHEQUE,
    '204759672937872032201300115004647410000000031050003016122024TT' as LIGNE_ORIGINE
FROM CARTHAGO c 
WHERE c.NOM_FICHIER = 'Donnees1612202408033904135.DATA';

-- Deuxième fichier - Détail 2
INSERT INTO CARTHAGO_DETAIL (CARTHAGO_ID, NUMERO_CHEQUE, MONTANT_CHEQUE, ETAT_CHEQUE, LIGNE_ORIGINE)
SELECT 
    c.ID,
    SUBSTR('204759676483759071210181101101498640000000028058583016122024TT', 1, 20) as NUMERO_CHEQUE,
    TO_NUMBER(SUBSTR('204759676483759071210181101101498640000000028058583016122024TT', 36, 15)) / 100 as MONTANT_CHEQUE,
    CASE 
        WHEN SUBSTR('204759676483759071210181101101498640000000028058583016122024TT', 80, 1) = 'A' THEN 'DEPOSE'
        ELSE 'REJETE'
    END as ETAT_CHEQUE,
    '204759676483759071210181101101498640000000028058583016122024TT' as LIGNE_ORIGINE
FROM CARTHAGO c 
WHERE c.NOM_FICHIER = 'Donnees1612202408033904135.DATA';

-- Deuxième fichier - Détail 3
INSERT INTO CARTHAGO_DETAIL (CARTHAGO_ID, NUMERO_CHEQUE, MONTANT_CHEQUE, ETAT_CHEQUE, LIGNE_ORIGINE)
SELECT 
    c.ID,
    SUBSTR('204759676747680032101190115004484750000000004244503016122024TT', 1, 20) as NUMERO_CHEQUE,
    TO_NUMBER(SUBSTR('204759676747680032101190115004484750000000004244503016122024TT', 36, 15)) / 100 as MONTANT_CHEQUE,
    CASE 
        WHEN SUBSTR('204759676747680032101190115004484750000000004244503016122024TT', 80, 1) = 'A' THEN 'DEPOSE'
        ELSE 'REJETE'
    END as ETAT_CHEQUE,
    '204759676747680032101190115004484750000000004244503016122024TT' as LIGNE_ORIGINE
FROM CARTHAGO c 
WHERE c.NOM_FICHIER = 'Donnees1612202408033904135.DATA';

-- Deuxième fichier - Détail 4
INSERT INTO CARTHAGO_DETAIL (CARTHAGO_ID, NUMERO_CHEQUE, MONTANT_CHEQUE, ETAT_CHEQUE, LIGNE_ORIGINE)
SELECT 
    c.ID,
    SUBSTR('204759670000304083000000010521408110000000002152003016122024TT', 1, 20) as NUMERO_CHEQUE,
    TO_NUMBER(SUBSTR('204759670000304083000000010521408110000000002152003016122024TT', 36, 15)) / 100 as MONTANT_CHEQUE,
    CASE 
        WHEN SUBSTR('204759670000304083000000010521408110000000002152003016122024TT', 80, 1) = 'A' THEN 'DEPOSE'
        ELSE 'REJETE'
    END as ETAT_CHEQUE,
    '204759670000304083000000010521408110000000002152003016122024TT' as LIGNE_ORIGINE
FROM CARTHAGO c 
WHERE c.NOM_FICHIER = 'Donnees1612202408033904135.DATA';

-- Deuxième fichier - Détail 5
INSERT INTO CARTHAGO_DETAIL (CARTHAGO_ID, NUMERO_CHEQUE, MONTANT_CHEQUE, ETAT_CHEQUE, LIGNE_ORIGINE)
SELECT 
    c.ID,
    SUBSTR('204759671728809210030034047002300200000000005365003016122024TT', 1, 20) as NUMERO_CHEQUE,
    TO_NUMBER(SUBSTR('204759671728809210030034047002300200000000005365003016122024TT', 36, 15)) / 100 as MONTANT_CHEQUE,
    CASE 
        WHEN SUBSTR('204759671728809210030034047002300200000000005365003016122024TT', 80, 1) = 'A' THEN 'DEPOSE'
        ELSE 'REJETE'
    END as ETAT_CHEQUE,
    '204759671728809210030034047002300200000000005365003016122024TT' as LIGNE_ORIGINE
FROM CARTHAGO c 
WHERE c.NOM_FICHIER = 'Donnees1612202408033904135.DATA';

-- Deuxième fichier - Détail 6
INSERT INTO CARTHAGO_DETAIL (CARTHAGO_ID, NUMERO_CHEQUE, MONTANT_CHEQUE, ETAT_CHEQUE, LIGNE_ORIGINE)
SELECT 
    c.ID,
    SUBSTR('204759671799548032101190115004017210000000011212243016122024TT', 1, 20) as NUMERO_CHEQUE,
    TO_NUMBER(SUBSTR('204759671799548032101190115004017210000000011212243016122024TT', 36, 15)) / 100 as MONTANT_CHEQUE,
    CASE 
        WHEN SUBSTR('204759671799548032101190115004017210000000011212243016122024TT', 80, 1) = 'A' THEN 'DEPOSE'
        ELSE 'REJETE'
    END as ETAT_CHEQUE,
    '204759671799548032101190115004017210000000011212243016122024TT' as LIGNE_ORIGINE
FROM CARTHAGO c 
WHERE c.NOM_FICHIER = 'Donnees1612202408033904135.DATA';

-- =============================================================================
-- 5. Vérification des insertions
-- =============================================================================

-- Vérifier les fichiers insérés
SELECT ID, NOM_FICHIER, DATE_IMPORT FROM CARTHAGO WHERE NOM_FICHIER LIKE 'Donnees%';

-- Vérifier les détails parsés
SELECT 
    c.NOM_FICHIER,
    cd.NUMERO_CHEQUE,
    cd.MONTANT_CHEQUE,
    cd.ETAT_CHEQUE,
    cd.LIGNE_ORIGINE
FROM CARTHAGO c
JOIN CARTHAGO_DETAIL cd ON c.ID = cd.CARTHAGO_ID
WHERE c.NOM_FICHIER LIKE 'Donnees%'
ORDER BY c.NOM_FICHIER, cd.NUMERO_CHEQUE;

-- Statistiques par fichier
SELECT 
    c.NOM_FICHIER,
    COUNT(cd.ID) as NOMBRE_TOTAL_CHEQUES,
    SUM(cd.MONTANT_CHEQUE) as MONTANT_TOTAL,
    COUNT(CASE WHEN cd.ETAT_CHEQUE = 'DEPOSE' THEN 1 END) as NOMBRE_DEPOSES,
    SUM(CASE WHEN cd.ETAT_CHEQUE = 'DEPOSE' THEN cd.MONTANT_CHEQUE ELSE 0 END) as MONTANT_DEPOSES,
    COUNT(CASE WHEN cd.ETAT_CHEQUE = 'REJETE' THEN 1 END) as NOMBRE_REJETES,
    SUM(CASE WHEN cd.ETAT_CHEQUE = 'REJETE' THEN cd.MONTANT_CHEQUE ELSE 0 END) as MONTANT_REJETES
FROM CARTHAGO c
LEFT JOIN CARTHAGO_DETAIL cd ON c.ID = cd.CARTHAGO_ID
WHERE c.NOM_FICHIER LIKE 'Donnees%'
GROUP BY c.ID, c.NOM_FICHIER, c.DATE_IMPORT;

-- =============================================================================
-- SCRIPT TERMINÉ
-- ============================================================================= 