# CARTHAGO DATABASE SCHEMA

## üìã Vue d'ensemble

Ce sch√©ma de base de donn√©es est con√ßu pour g√©rer le traitement et la comparaison des fichiers Carthago avec les fichiers Encaisse Valeur. Il permet de stocker, parser et comparer les donn√©es de ch√®ques entre les deux syst√®mes.

## üóÇÔ∏è Structure des Tables

### 1. Table `CARTHAGO`
Stocke les fichiers Carthago bruts (.DATA) avant parsing.

```sql
CREATE TABLE CARTHAGO (
    ID            NUMBER(19) GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    NOM_FICHIER   VARCHAR2(255 CHAR), -- nom du fichier Carthago
    DATE_IMPORT   DATE DEFAULT SYSDATE,
    CONTENU       CLOB,               -- contenu brut
    CREATED_AT    DATE DEFAULT SYSDATE
);
```

**Champs :**
- `ID` : Identifiant unique auto-g√©n√©r√©
- `NOM_FICHIER` : Nom original du fichier Carthago
- `DATE_IMPORT` : Date d'import du fichier
- `CONTENU` : Contenu brut du fichier (.DATA)
- `CREATED_AT` : Date de cr√©ation de l'enregistrement

### 2. Table `CARTHAGO_DETAIL`
Stocke chaque ch√®que issu du parsing de CARTHAGO. Permet de voir d√©p√¥t/rejet et d'avoir le montant exact.

```sql
CREATE TABLE CARTHAGO_DETAIL (
    ID               NUMBER(19) GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    CARTHAGO_ID      NUMBER(19) REFERENCES CARTHAGO(ID) ON DELETE CASCADE,
    NUMERO_CHEQUE    VARCHAR2(50 CHAR),  -- num√©ro du ch√®que si pr√©sent
    MONTANT_CHEQUE   NUMBER(15,2),
    ETAT_CHEQUE      VARCHAR2(10 CHAR),  -- 'DEPOSE' ou 'REJETE'
    LIGNE_ORIGINE    VARCHAR2(500 CHAR)  -- ligne brute du fichier
);
```

**Champs :**
- `ID` : Identifiant unique auto-g√©n√©r√©
- `CARTHAGO_ID` : R√©f√©rence vers le fichier Carthago parent
- `NUMERO_CHEQUE` : Num√©ro du ch√®que si pr√©sent dans le fichier
- `MONTANT_CHEQUE` : Montant du ch√®que
- `ETAT_CHEQUE` : √âtat du ch√®que (DEPOSE ou REJETE)
- `LIGNE_ORIGINE` : Ligne brute du fichier source

### 3. Table `CTR`
Stocke le r√©sultat de la comparaison entre Encaisse Valeur (FICHIER) et Carthago.

```sql
CREATE TABLE CTR (
    ID                       NUMBER(19) GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    FICHIER_ID               NUMBER(19) REFERENCES FICHIERS(ID_FICHIER),
    CARTHAGO_ID              NUMBER(19) REFERENCES CARTHAGO(ID),

    -- Donn√©es Carthago
    NOMBRE_TOTAL_CARTHAGO    NUMBER(10),
    MONTANT_TOTAL_CARTHAGO   NUMBER(15,2),
    NOMBRE_DEP_CARTHAGO      NUMBER(10),    -- ch√®ques d√©pos√©s
    MONTANT_DEP_CARTHAGO     NUMBER(15,2),
    NOMBRE_REJ_CARTHAGO      NUMBER(10),    -- ch√®ques rejet√©s
    MONTANT_REJ_CARTHAGO     NUMBER(15,2),

    -- Donn√©es Encaisse Valeur (FICHIERS)
    NOMBRE_FICHIER           NUMBER(10),
    MONTANT_FICHIER          NUMBER(15,2),

    -- R√©sultat comparaison
    NOMBRE_OK                CHAR(1),       -- 'Y' ou 'N'
    MONTANT_OK               CHAR(1),       -- 'Y' ou 'N'

    CREATED_AT               DATE DEFAULT SYSDATE
);
```

**Champs :**
- `ID` : Identifiant unique auto-g√©n√©r√©
- `FICHIER_ID` : R√©f√©rence vers le fichier Encaisse Valeur
- `CARTHAGO_ID` : R√©f√©rence vers le fichier Carthago
- `NOMBRE_TOTAL_CARTHAGO` : Nombre total de ch√®ques dans Carthago
- `MONTANT_TOTAL_CARTHAGO` : Montant total des ch√®ques dans Carthago
- `NOMBRE_DEP_CARTHAGO` : Nombre de ch√®ques d√©pos√©s dans Carthago
- `MONTANT_DEP_CARTHAGO` : Montant total des ch√®ques d√©pos√©s
- `NOMBRE_REJ_CARTHAGO` : Nombre de ch√®ques rejet√©s dans Carthago
- `MONTANT_REJ_CARTHAGO` : Montant total des ch√®ques rejet√©s
- `NOMBRE_FICHIER` : Nombre de ch√®ques dans le fichier Encaisse Valeur
- `MONTANT_FICHIER` : Montant total dans le fichier Encaisse Valeur
- `NOMBRE_OK` : Correspondance du nombre (Y ou N)
- `MONTANT_OK` : Correspondance du montant (Y ou N)
- `CREATED_AT` : Date de cr√©ation de la comparaison

## üîó Relations

```
FICHIER (remises Encaisse Valeur)
   ‚îÇ
   ‚ñº
CTR (r√©sultat comparaison)
   ‚ñ≤
   ‚îÇ
CARTHAGO (fichier brut)
   ‚îÇ
   ‚ñº
CARTHAGO_DETAIL (ch√®ques Carthago)
```

## üìä Vues Utiles

### Vue `V_CARTHAGO_SUMMARY`
R√©sum√© des fichiers Carthago avec statistiques :

```sql
CREATE OR REPLACE VIEW V_CARTHAGO_SUMMARY AS
SELECT 
    c.ID,
    c.NOM_FICHIER,
    c.DATE_IMPORT,
    COUNT(cd.ID) as NOMBRE_TOTAL_CHEQUES,
    SUM(cd.MONTANT_CHEQUE) as MONTANT_TOTAL,
    COUNT(CASE WHEN cd.ETAT_CHEQUE = 'DEPOSE' THEN 1 END) as NOMBRE_DEPOSES,
    SUM(CASE WHEN cd.ETAT_CHEQUE = 'DEPOSE' THEN cd.MONTANT_CHEQUE ELSE 0 END) as MONTANT_DEPOSES,
    COUNT(CASE WHEN cd.ETAT_CHEQUE = 'REJETE' THEN 1 END) as NOMBRE_REJETES,
    SUM(CASE WHEN cd.ETAT_CHEQUE = 'REJETE' THEN cd.MONTANT_CHEQUE ELSE 0 END) as MONTANT_REJETES
FROM CARTHAGO c
LEFT JOIN CARTHAGO_DETAIL cd ON c.ID = cd.CARTHAGO_ID
GROUP BY c.ID, c.NOM_FICHIER, c.DATE_IMPORT;
```

### Vue `V_CTR_COMPARISON`
Comparaison CTR avec noms de fichiers :

```sql
CREATE OR REPLACE VIEW V_CTR_COMPARISON AS
SELECT 
    ctr.ID,
    f.NOM_FICHIER as FICHIER_NOM,
    car.NOM_FICHIER as CARTHAGO_NOM,
    ctr.NOMBRE_FICHIER,
    ctr.MONTANT_FICHIER,
    ctr.NOMBRE_TOTAL_CARTHAGO,
    ctr.MONTANT_TOTAL_CARTHAGO,
    ctr.NOMBRE_OK,
    ctr.MONTANT_OK,
    ctr.CREATED_AT
FROM CTR ctr
JOIN FICHIERS f ON ctr.FICHIER_ID = f.ID_FICHIER
JOIN CARTHAGO car ON ctr.CARTHAGO_ID = car.ID;
```

## üöÄ Utilisation

### 1. Import d'un fichier Carthago
```java
// Cr√©er un enregistrement Carthago
Carthago carthago = new Carthago("carthago_20241201.DATA", contenuBrut);
carthagoRepository.save(carthago);

// Parser le contenu et cr√©er les d√©tails
List<CarthagoDetail> details = parseCarthagoFile(contenuBrut);
for (CarthagoDetail detail : details) {
    detail.setCarthago(carthago);
    carthagoDetailRepository.save(detail);
}
```

### 2. Comparaison avec fichier Encaisse Valeur
```java
// Cr√©er une comparaison CTR
CTR ctr = new CTR(fichierEncaisse, carthago);
ctr.setNombreFichier(fichierEncaisse.getNombre());
ctr.setMontantFichier(BigDecimal.valueOf(fichierEncaisse.getMontant()));

// Calculer les statistiques Carthago
ctr.setNombreTotalCarthago(calculateTotalCheques(carthago));
ctr.setMontantTotalCarthago(calculateTotalMontant(carthago));

// Comparer
ctr.setNombreOk(nombreFichier.equals(nombreCarthago) ? "Y" : "N");
ctr.setMontantOk(montantFichier.compareTo(montantCarthago) == 0 ? "Y" : "N");

ctrRepository.save(ctr);
```

### 3. Requ√™tes utiles

#### Trouver tous les fichiers Carthago avec leurs statistiques
```sql
SELECT * FROM V_CARTHAGO_SUMMARY ORDER BY DATE_IMPORT DESC;
```

#### Trouver les comparaisons avec des √©carts
```sql
SELECT * FROM V_CTR_COMPARISON 
WHERE NOMBRE_OK = 'N' OR MONTANT_OK = 'N'
ORDER BY CREATED_AT DESC;
```

#### Statistiques par date
```sql
SELECT 
    TRUNC(CREATED_AT) as DATE_COMPARAISON,
    COUNT(*) as NOMBRE_COMPARAISONS,
    SUM(CASE WHEN NOMBRE_OK = 'Y' AND MONTANT_OK = 'Y' THEN 1 ELSE 0 END) as COMPARAISONS_OK,
    SUM(CASE WHEN NOMBRE_OK = 'N' OR MONTANT_OK = 'N' THEN 1 ELSE 0 END) as COMPARAISONS_KO
FROM CTR 
GROUP BY TRUNC(CREATED_AT)
ORDER BY DATE_COMPARAISON DESC;
```

## üîß Index de Performance

Les index suivants ont √©t√© cr√©√©s pour optimiser les performances :

```sql
-- Index sur les cl√©s √©trang√®res
CREATE INDEX IDX_CARTHAGO_DETAIL_CARTHAGO_ID ON CARTHAGO_DETAIL(CARTHAGO_ID);
CREATE INDEX IDX_CTR_FICHIER_ID ON CTR(FICHIER_ID);
CREATE INDEX IDX_CTR_CARTHAGO_ID ON CTR(CARTHAGO_ID);

-- Index sur les colonnes fr√©quemment utilis√©es
CREATE INDEX IDX_CARTHAGO_NOM_FICHIER ON CARTHAGO(NOM_FICHIER);
CREATE INDEX IDX_CARTHAGO_DATE_IMPORT ON CARTHAGO(DATE_IMPORT);
CREATE INDEX IDX_CARTHAGO_DETAIL_ETAT ON CARTHAGO_DETAIL(ETAT_CHEQUE);
CREATE INDEX IDX_CTR_CREATED_AT ON CTR(CREATED_AT);
```

## üìù Notes Importantes

1. **Sch√©ma** : Toutes les tables utilisent le sch√©ma `RUYA`
2. **Cascade** : La suppression d'un fichier Carthago supprime automatiquement tous ses d√©tails
3. **Pr√©cision** : Les montants utilisent `NUMBER(15,2)` pour une pr√©cision de 2 d√©cimales
4. **√âtats** : Les ch√®ques peuvent √™tre 'DEPOSE' ou 'REJETE'
5. **Comparaisons** : Les r√©sultats de comparaison sont 'Y' (OK) ou 'N' (KO)

## üõ†Ô∏è Installation

1. Ex√©cuter le script `carthago_schema.sql` dans votre base de donn√©es Oracle
2. V√©rifier que les tables ont √©t√© cr√©√©es correctement
3. Tester les vues avec quelques requ√™tes de base

## üìû Support

Pour toute question ou probl√®me avec ce sch√©ma, consultez la documentation du projet ou contactez l'√©quipe de d√©veloppement. 